plugins {
	id 'java'
	id 'org.springframework.boot' version '3.4.5'
	id 'io.spring.dependency-management' version '1.1.7'
}

group = 'yeonjae'
version = '0.0.1-SNAPSHOT'

java {
	toolchain {
		languageVersion = JavaLanguageVersion.of(17)
	}
}

configurations {
	compileOnly {
		extendsFrom annotationProcessor
	}
}

repositories {
	mavenCentral()
}

// ì‹¤í–‰ ê°€ëŠ¥í•œ JAR ìƒì„± ì„¤ì •
bootJar {
	enabled = true
}

// ì¼ë°˜ JAR íŒŒì¼ ìƒì„± ë¹„í™œì„±í™”
jar {
	enabled = false
}

// bootRun íƒœìŠ¤í¬ì— í™˜ê²½ ë³€ìˆ˜ ì£¼ì… (ì„ íƒì‚¬í•­)
tasks.named('bootRun') {
	// .env íŒŒì¼ì—ì„œ í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
	if (file('.env').exists()) {
		file('.env').readLines().each { line ->
			if (line && !line.startsWith('#') && line.contains('=')) {
				def (key, value) = line.split('=', 2)
				if (key && value) {
					environment key.trim(), value.trim()
				}
			}
		}
	}

	// ë˜ëŠ” ì‹œìŠ¤í…œ í™˜ê²½ ë³€ìˆ˜ ì „ë‹¬
	systemProperties = System.properties
}

// k6 ë¶€í•˜í…ŒìŠ¤íŠ¸ìš© ë°ì´í„° ìƒì„± Task
task runDataGenerator(type: JavaExec) {
	group = 'load-test'
	description = 'k6 ë¶€í•˜í…ŒìŠ¤íŠ¸ìš© CSV ë°ì´í„° ìƒì„±'
	mainClass = 'yeonjae.snapguide.controller.initData.LoadTestDataGenerator'
	classpath = sourceSets.main.runtimeClasspath

	doFirst {
		println 'ğŸš€ ë¶€í•˜í…ŒìŠ¤íŠ¸ìš© CSV ë°ì´í„° ìƒì„± ì‹œì‘...'
	}

	doLast {
		println 'âœ… CSV ìƒì„± ì™„ë£Œ!'
		println 'ğŸ“ íŒŒì¼ ìœ„ì¹˜: src/main/resources/load-test-data/'
	}
}

dependencies {
	implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
 	implementation 'org.springframework.boot:spring-boot-starter-security'
	// implementation 'org.springframework.boot:spring-boot-starter-thymeleaf'
	implementation 'org.springframework.boot:spring-boot-starter-validation'
	implementation 'org.springframework.boot:spring-boot-starter-web'
	// implementation 'org.thymeleaf.extras:thymeleaf-extras-springsecurity6'

	// ì¶”ê°€
	implementation 'com.github.gavlyukovskiy:p6spy-spring-boot-starter:1.9.0'
    implementation 'org.springframework.boot:spring-boot-starter-actuator'

	// OpenTelemetry for Spring Boot 3.x
	implementation 'io.micrometer:micrometer-registry-otlp'
	implementation 'io.opentelemetry:opentelemetry-api'
	implementation 'io.opentelemetry.instrumentation:opentelemetry-logback-appender-1.0:2.2.0-alpha'

	// Logback JSON logging
	implementation 'net.logstash.logback:logstash-logback-encoder:7.4'


    compileOnly 'org.projectlombok:lombok'
	runtimeOnly 'com.h2database:h2'
	annotationProcessor 'org.projectlombok:lombok'
	testImplementation 'org.springframework.boot:spring-boot-starter-test'
	 testImplementation 'org.springframework.security:spring-security-test'
	testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
	testImplementation 'org.mockito:mockito-inline:5.2.0' // static ë©”ì„œë“œ mockingìš©

	// for handel metadata
	implementation 'com.drewnoakes:metadata-extractor:2.18.0'

	// ì¶”ê°€, test ë¡¬ë³µ ì‚¬ìš©
	testCompileOnly 'org.projectlombok:lombok'
	testAnnotationProcessor 'org.projectlombok:lombok'

	// google maps api ìš©
	implementation 'org.springframework.boot:spring-boot-starter-webflux'

	//security
	implementation 'org.springframework.boot:spring-boot-starter-oauth2-client'
	implementation 'org.springframework.boot:spring-boot-starter-oauth2-resource-server'

	//jwt
	implementation 'io.jsonwebtoken:jjwt-api:0.12.5'
	implementation 'io.jsonwebtoken:jjwt-impl:0.12.5'
	implementation 'io.jsonwebtoken:jjwt-jackson:0.12.5'

	//swagger
	implementation('org.springdoc:springdoc-openapi-starter-webmvc-ui:2.3.0')

	// redis
	implementation 'org.springframework.boot:spring-boot-starter-data-redis'

	// oauth2.0
	implementation 'org.springframework.boot:spring-boot-starter-oauth2-client'

	// Querydsl ì¶”ê°€
	implementation 'com.querydsl:querydsl-jpa:5.0.0:jakarta'
	annotationProcessor "com.querydsl:querydsl-apt:${dependencyManagement.importedProperties['querydsl.version']}:jakarta"
	annotationProcessor "jakarta.annotation:jakarta.annotation-api"
	annotationProcessor "jakarta.persistence:jakarta.persistence-api"

	// HEIC -> JPEG ë³€í™˜ìš©
	implementation 'org.im4java:im4java:1.4.0'

	// openCSV (ì˜¤í”ˆ ë°ì´í„° ê°€ì ¸ì˜¨ê±° ì²˜ë¦¬)
	implementation("com.opencsv:opencsv:5.9")
	implementation("com.fasterxml.jackson.core:jackson-databind")

	// aop
	implementation 'org.springframework.boot:spring-boot-starter-aop'

	//postgreSQL
	implementation 'org.postgresql:postgresql:42.7.3'
	implementation 'org.hibernate:hibernate-spatial:6.4.4.Final' // PostGIS ì§€ì›ì„ ìœ„í•´ í•„ìš”
	// implementation 'com.querydsl:querydsl-spatial'
	implementation 'org.locationtech.jts:jts-core:1.19.0' // JTS Geometry ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€, Point íƒ€ì… ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œ. jtsëŠ” ê³µê°„ ê´€ë ¨ ê¸°ëŠ¥ì„ ì œê³µí•˜ëŠ” Javaì˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ì´ë‹¤.

	// ì¸ë„¤ì¼ìš©
	implementation 'net.coobird:thumbnailator:0.4.14'

	// aws
	// Spring Cloud AWS BOM (Bill of Materials)
	implementation platform("io.awspring.cloud:spring-cloud-aws-dependencies:3.1.1")

	// AWS Parameter Store ì‚¬ìš©ì„ ìœ„í•œ ì˜ì¡´ì„±
	implementation "io.awspring.cloud:spring-cloud-aws-starter-parameter-store"

	// aws amazonS3 ê°ì²´ëŠ” ì´ê±°?
	implementation 'org.springframework.cloud:spring-cloud-starter-aws:2.2.6.RELEASE'

	// (ì„ íƒ) Secrets Managerë¥¼ ì‚¬ìš©í•œë‹¤ë©´ ì•„ë˜ ì˜ì¡´ì„± ì¶”ê°€
	// implementation "io.awspring.cloud:spring-cloud-aws-starter-secrets-manager"

	implementation 'org.apache.tika:tika-core:2.9.2' // Apache Tika , íŒŒì¼í™•ì¥ì ê²€ì‚¬ìš© íŠ¹íˆ heic

	// TwelveMonkeys ImageIO í”ŒëŸ¬ê·¸ì¸ ì¶”ê°€ (HEIC, WebP ë“± ë‹¤ì–‘í•œ í¬ë§· ì§€ì›)
//	implementation('com.twelvemonkeys.imageio:imageio-heif:3.10.1')

	// Jackson - Java 8 ë‚ ì§œ/ì‹œê°„ íƒ€ì… ì§€ì› ëª¨ë“ˆ
	implementation 'com.fasterxml.jackson.datatype:jackson-datatype-jsr310'

}

tasks.named('test') {
	useJUnitPlatform()
}
