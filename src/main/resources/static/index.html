<!-- index.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>SnapGuide Test with Server-Side Places API</title>
    <!-- Google Maps API ìŠ¤í¬ë¦½íŠ¸ëŠ” JavaScriptê°€ ë™ì ìœ¼ë¡œ ë¡œë“œí•©ë‹ˆë‹¤. -->
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; padding-bottom: 100px; line-height: 1.6; }
        h1, h3 { border-bottom: 1px solid #eee; padding-bottom: 10px; }
        div { margin-bottom: 15px; }
        input, textarea, button, select { padding: 10px; margin: 2px; border-radius: 6px; border: 1px solid #ccc; font-size: 1em; }
        button, a { cursor: pointer; background-color: #4285F4; color: white; border: none; text-decoration: none; display: inline-block; padding: 10px 15px; }
        a:hover, button:hover { background-color: #357ae8; }
        #guideWrap, #guideNear { display: flex; flex-wrap: wrap; gap: 10px; }
        .guide-card { border: 1px solid #ddd; margin: 10px; padding: 10px; width: 260px; display: flex; flex-direction: column; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-radius: 8px; }
        .img-box { width: 100%; height: 260px; overflow: hidden; position: relative; cursor: pointer; background-color: #f0f0f0; border-radius: 6px 6px 0 0; }
        .img-box img { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
        .guide-card p { margin: 10px 0; flex-grow: 1; }
        .meta-info { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; font-size: 0.9em; color: #555; }
        .like-btn { background: none; border: none; cursor: pointer; font-size: 1.5rem; padding: 0; line-height: 1; color: #ff4d4f; }
        .like-count { font-weight: bold; }
        .button-group { margin-top: auto; display: flex; gap: 5px; }
        .button-group button { flex-grow: 1; }

        /* ìœ„ì¹˜ ê²€ìƒ‰ UI ìŠ¤íƒ€ì¼ */
        #locationSearchSection { background-color: #f8f9fa; padding: 20px; border-radius: 8px; }
        #map { width: 100%; height: 400px; border: 1px solid #ddd; margin-bottom: 15px; }
        #searchBox { position: relative; } /* ìë™ì™„ì„± ê²°ê³¼ë¥¼ ìœ„í•œ position ê¸°ì¤€ */
        #locationSearchInput { width: calc(100% - 24px); }
        #searchStatus { text-align: center; font-weight: bold; font-size: 1.1em; color: #333; }
        #autocompleteResults { position: absolute; background: white; border: 1px solid #ddd; z-index: 1000; width: 100%; max-height: 200px; overflow-y: auto; }
        #autocompleteResults div { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        #autocompleteResults div:hover { background-color: #f0f0f0; }
    </style>
</head>
<body>
<!-- HTML êµ¬ì¡°ëŠ” ê¸°ì¡´ê³¼ ë™ì¼ -->
<h1>íšŒì›ê°€ì…</h1>
<input id="email" placeholder="ì´ë©”ì¼" /><input id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" type="password" /><button onclick="signup()">íšŒì›ê°€ì…</button>
<h1>ë¡œê·¸ì¸</h1>
<input id="loginEmail" placeholder="ì´ë©”ì¼" /><input id="loginPassword" placeholder="ë¹„ë°€ë²ˆí˜¸" type="password" /><button onclick="login()">ë¡œê·¸ì¸</button>
<h1>êµ¬ê¸€ ë¡œê·¸ì¸</h1>
<a href="/oauth2/authorization/google">êµ¬ê¸€ ë¡œê·¸ì¸</a>
<h1>í† í° ì¬ë°œê¸‰</h1>
<button onclick="reissueToken()">í† í° ì¬ë°œê¸‰</button>
<h1>ë¡œê·¸ì•„ì›ƒ</h1>
<button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
<h1>ì¸ì¦ í…ŒìŠ¤íŠ¸</h1>
<button onclick="authTest()">ì¸ì¦ëœ ì‚¬ìš©ì í™•ì¸</button><div id="authResult"></div>
<h1>ê°€ì´ë“œ ì—…ë¡œë“œ</h1>
<input type="file" id="imageFile" name="file" multiple><label for="tip"></label><textarea id="tip" placeholder="íŒì„ ì…ë ¥í•˜ì„¸ìš”"></textarea><button onclick="upload()">ì—…ë¡œë“œ</button>
<h1>ìœ ì € ê°€ì´ë“œ ì‘ì„± ë¦¬ìŠ¤íŠ¸</h1>
<button onclick="loadUserGuides()">ì‚¬ìš©ì ê°€ì´ë“œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button><div id="guideWrap"></div>
<div id="locationSearchSection">
    <h1>ğŸ“ ìœ„ì¹˜ ê¸°ë°˜ ê°€ì´ë“œ ê²€ìƒ‰</h1>
    <div id="map" style="background-color:#e0e0e0;">ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    <p id="searchStatus">ì§€ë„ë¥¼ ì›€ì§ì—¬ ê²€ìƒ‰ ê¸°ì¤€ì ì„ ì„¤ì •í•˜ê±°ë‚˜ ì¥ì†Œë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”.</p>
    <div id="searchBox">
        <input id="locationSearchInput" placeholder="ì¥ì†Œ, ì£¼ì†Œ ê²€ìƒ‰ (ì˜ˆ: ì°½ì› ì‹œì²­)" />
        <div id="autocompleteResults"></div>
    </div>
    <div>
        <button id="currentLocationBtn">ğŸ›°ï¸ ë‚´ í˜„ì¬ ìœ„ì¹˜ë¡œ ê²€ìƒ‰</button>
        <select id="radiusSelect">
            <option value="5">ë°˜ê²½ 5km</option><option value="10" selected>ë°˜ê²½ 10km</option><option value="20">ë°˜ê²½ 20km</option><option value="50">ë°˜ê²½ 50km</option><option value="100">ë°˜ê²½ 100km</option>
        </select>
    </div>
    <div id="guideNear"></div>
</div>
<h1>ì‚¬ì§„ ëª©ë¡ ë³´ê¸°</h1>
<button onclick="loadPhotos()">ì‚¬ì§„ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button><div id="photoList"></div>
<h1>ëª¨ë“  ì‚¬ì§„ ë³´ê¸°</h1>
<h3 id="photoCountText">ğŸ“· ì „ì²´ ì‚¬ì§„ ìˆ˜: ì•Œ ìˆ˜ ì—†ìŒ</h3>
<div id="allPhotoContainer" style="height: 500px; overflow-y: auto; border: 1px solid gray;"><div id="allPhoto"></div></div>
<div style="margin-top: 10px;">
    <button id="prevPageBtn" disabled>â¬…ï¸ ì´ì „</button><button id="nextPageBtn" disabled>â¡ï¸ ë‹¤ìŒ</button><button id="loadStartBtn">ğŸ“¸ ì‚¬ì§„ ë¶ˆëŸ¬ì˜¤ê¸° ì‹œì‘</button><span id="loadingText" style="margin-left: 10px; display: none;">âŒ› ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
</div>
<h1>ë©¤ë²„ ë¦¬ìŠ¤íŠ¸ ë³´ê¸°</h1>
<button onclick="loadMembers()">ë©¤ë²„ ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°</button><ul id="memberList"></ul>

<script>
    let token = localStorage.getItem("accessToken") || null;

    // í˜ì´ì§€ ë¡œë”© ì‹œ ì‹¤í–‰
    document.addEventListener('DOMContentLoaded', () => {
        handleRedirectToken();
        token = localStorage.getItem("accessToken");
        loadGoogleMapsScript();

        // ğŸ”¹ ì¤‘ë³µë˜ë˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤ì„ ì—¬ê¸°ì„œ í•œ ë²ˆë§Œ ë“±ë¡í•©ë‹ˆë‹¤.
        const startBtn = document.getElementById("loadStartBtn");
        const nextBtn = document.getElementById("nextPageBtn");
        const prevBtn = document.getElementById("prevPageBtn");

        startBtn.addEventListener("click", () => {
            page = 0;
            done = false;
            photoContainer.innerHTML = "";
            nextBtn.style.display = "inline-block";
            prevBtn.style.display = "inline-block";
            nextBtn.disabled = false;
            fetchPhotoCount();
            allPhotos();
        });
        nextBtn.addEventListener("click", () => { if (!done) { page++; allPhotos(); } });
        prevBtn.addEventListener("click", () => { if (page > 0) { page--; allPhotos(); } });
    });

    function loadGoogleMapsScript() {
        fetch("http://localhost:8080/api/maps/key")
            .then(res => res.ok ? res.json() : Promise.reject("Could not fetch map API key."))
            .then(data => {
                const apiKey = data.apiKey;
                if (!apiKey) throw new Error("API key is missing.");
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places&callback=initMap`;
                script.async = true;
                script.defer = true;
                document.head.appendChild(script);
            })
            .catch(err => {
                console.error("Failed to load Google Maps:", err);
                document.getElementById('map').textContent = "ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. API ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.";
                alert("ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            });
    }

    // ì„œë²„ ê¸°ë°˜ ì¥ì†Œ ê²€ìƒ‰ API
    /**
     * ì„œë²„ì— ì¥ì†Œ ìë™ì™„ì„±ì„ ìš”ì²­í•©ë‹ˆë‹¤. (React Native ì½”ë“œì™€ ë™ì¼ ë¡œì§)
     */
    async function fetchPlaceAutocomplete(input) {
        if (!input || input.trim().length < 2) return [];
        if (!token) {
            console.error('[fetchPlaceAutocomplete] í† í°ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            alert('ì¥ì†Œ ê²€ìƒ‰ì„ ìœ„í•´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            return [];
        }
        try {
            const url = `http://localhost:8080/location/api/places/autocomplete?input=${encodeURIComponent(input)}`;
            const response = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
            if (!response.ok) throw new Error(`Network response was not ok: ${response.status}`);
            const data = await response.json();
            return data?.predictions || [];
        } catch (error) {
            console.error('ì¥ì†Œ ìë™ì™„ì„± API í˜¸ì¶œ ì˜¤ë¥˜:', error);
            alert('ì¥ì†Œë¥¼ ê²€ìƒ‰í•˜ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            return [];
        }
    }

    /**
     * ì„œë²„ì— ì¥ì†Œ ìƒì„¸ ì •ë³´(ì¢Œí‘œ í¬í•¨)ë¥¼ ìš”ì²­í•©ë‹ˆë‹¤. (React Native ì½”ë“œì™€ ë™ì¼ ë¡œì§)
     */
    async function fetchPlaceDetails(placeId) {
        if (!placeId) return null;
        if (!token) {
            console.error('[fetchPlaceDetails] í† í°ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            alert('ì¥ì†Œ ìƒì„¸ ì •ë³´ë¥¼ ìœ„í•´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            return null;
        }
        try {
            const url = `http://localhost:8080/location/api/places/details?placeId=${encodeURIComponent(placeId)}`;
            const response = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
            if (!response.ok) throw new Error(`Network response was not ok: ${response.status}`);
            const data = await response.json();
            return data?.result || null;
        } catch (error) {
            console.error('ì¥ì†Œ ìƒì„¸ ì •ë³´ API í˜¸ì¶œ ì˜¤ë¥˜:', error);
            alert('ì¥ì†Œì˜ ìƒì„¸ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            return null;
        }
    }


    // ====================================================================================
    // ğŸ”¹ 1. Google Maps ì´ˆê¸°í™” í•¨ìˆ˜ë¥¼ ì „ì—­(window)ì— í• ë‹¹í•©ë‹ˆë‹¤.
    // ====================================================================================
    let map;
    let marker;
    let searchCircle;
    let currentSearchCoords = null;

    window.initMap = function() { // ğŸ‘ˆ function initMap() -> window.initMap = function() ìœ¼ë¡œ ë³€ê²½!
        console.log("Google Maps API loaded, executing initMap..."); // ğŸ‘ˆ ë””ë²„ê¹…ìš© ë¡œê·¸
        const defaultLocation = { lat: 35.2283, lng: 128.6814 };
        map = new google.maps.Map(document.getElementById('map'), { center: defaultLocation, zoom: 13 });
        marker = new google.maps.Marker({ position: defaultLocation, map: map, draggable: true });
        searchCircle = new google.maps.Circle({
            strokeColor: '#4285F4', strokeWeight: 2, fillOpacity: 0.15, map: map,
            center: defaultLocation, radius: 10000
        });

        map.addListener('click', (e) => updateMapAndSearch({ lat: e.latLng.lat(), lng: e.latLng.lng() }, 'ì§€ë„ì—ì„œ ì„ íƒí•œ ìœ„ì¹˜'));
        marker.addListener('dragend', (e) => updateMapAndSearch({ lat: e.latLng.lat(), lng: e.latLng.lng() }, 'ë§ˆì»¤ ìœ„ì¹˜'));
        document.getElementById('currentLocationBtn').onclick = handleGetCurrentLocation;
        document.getElementById('radiusSelect').onchange = handleRadiusChange;
        document.getElementById('locationSearchInput').addEventListener('input', debounce(handleLocationSearchInput, 300));

        handleGetCurrentLocation();
    }

    // --- ì´í•˜ ëª¨ë“  í•¨ìˆ˜ëŠ” ì´ì „ ì½”ë“œì™€ ë™ì¼ ---
    // (ê°€ë…ì„±ì„ ìœ„í•´ í•œ ì¤„ë¡œ ì¶•ì•½)
    let page=0,size=10,totalCount=0,loading=false,done=false;
    function debounce(func,delay){let timeout;return function(...args){clearTimeout(timeout);timeout=setTimeout(()=>func.apply(this,args),delay)}}
    async function fetchPlaceAutocomplete(input){if(!input||input.trim().length<2||!token)return[];try{const url=`http://localhost:8080/location/api/places/autocomplete?input=${encodeURIComponent(input)}`;const response=await fetch(url,{headers:{'Authorization':`Bearer ${token}`}});if(!response.ok)throw new Error(`Network response was not ok: ${response.status}`);const data=await response.json();return data?.predictions||[]}catch(error){console.error('ì¥ì†Œ ìë™ì™„ì„± API í˜¸ì¶œ ì˜¤ë¥˜:',error);return[]}}
    async function fetchPlaceDetails(placeId){if(!placeId||!token)return null;try{const url=`http://localhost:8080/location/api/places/details?placeId=${encodeURIComponent(placeId)}`;const response=await fetch(url,{headers:{'Authorization':`Bearer ${token}`}});if(!response.ok)throw new Error(`Network response was not ok: ${response.status}`);const data=await response.json();return data?.result||null}catch(error){console.error('ì¥ì†Œ ìƒì„¸ ì •ë³´ API í˜¸ì¶œ ì˜¤ë¥˜:',error);return null}}
    async function handleLocationSearchInput(event){const query=event.target.value;const results=await fetchPlaceAutocomplete(query);displayAutocompleteResults(results)}
    function displayAutocompleteResults(predictions){const resultsContainer=document.getElementById('autocompleteResults');resultsContainer.innerHTML='';predictions.forEach(prediction=>{const item=document.createElement('div');item.textContent=prediction.description;item.onclick=async()=>{document.getElementById('locationSearchInput').value=prediction.description;resultsContainer.innerHTML='';const details=await fetchPlaceDetails(prediction.place_id);if(details&&details.geometry&&details.geometry.location){const coords={lat:details.geometry.location.lat,lng:details.geometry.location.lng};updateMapAndSearch(coords,prediction.description)}else{alert('ì¥ì†Œì˜ ì¢Œí‘œë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.')}};resultsContainer.appendChild(item)})}
    function updateMapAndSearch(coords,locationName){currentSearchCoords=coords;document.getElementById('searchStatus').textContent=`ê¸°ì¤€ ìœ„ì¹˜: ${locationName}`;map.panTo(coords);marker.setPosition(coords);searchCircle.setCenter(coords);const radius=document.getElementById('radiusSelect').value;fetchGuides(coords.lat,coords.lng,radius)}
    function handleGetCurrentLocation(){if(navigator.geolocation){navigator.geolocation.getCurrentPosition((position)=>{const coords={lat:position.coords.latitude,lng:position.coords.longitude};updateMapAndSearch(coords,'ë‚´ í˜„ì¬ ìœ„ì¹˜')},()=>{alert('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ìœ„ì¹˜ì—ì„œ ê²€ìƒ‰í•©ë‹ˆë‹¤.');updateMapAndSearch({lat:35.2283,lng:128.6814},'ì°½ì› ì‹œì²­(ê¸°ë³¸ê°’)')})}else{alert('ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.')}}
    function handleRadiusChange(){if(!currentSearchCoords){alert('ë¨¼ì € ê²€ìƒ‰ ê¸°ì¤€ ìœ„ì¹˜ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.');return}const radiusKm=document.getElementById('radiusSelect').value;searchCircle.setRadius(radiusKm*1000);fetchGuides(currentSearchCoords.lat,currentSearchCoords.lng,radiusKm)}
    function handleRedirectToken(){const urlParams=new URLSearchParams(window.location.search);const accessToken=urlParams.get("accessToken");const refreshToken=urlParams.get("refreshToken");if(accessToken&&refreshToken){localStorage.setItem("accessToken",accessToken);localStorage.setItem("refreshToken",refreshToken);alert("êµ¬ê¸€ ë¡œê·¸ì¸ ì„±ê³µ!");window.history.replaceState({},document.title,window.location.pathname)}}
    function signup(){fetch("http://localhost:8080/api/auth/signup",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:document.getElementById("email").value,password:document.getElementById("password").value})}).then(res=>{if(!res.ok)throw new Error(`HTTP Error: ${res.status}`);alert("íšŒì›ê°€ì… ì„±ê³µ! ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.");return res.json()}).catch(err=>alert(err.message))}
    function login(){const email=document.getElementById("loginEmail").value;const password=document.getElementById("loginPassword").value;fetch("http://localhost:8080/api/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email,password})}).then(res=>{if(!res.ok)throw new Error("ë¡œê·¸ì¸ ì‹¤íŒ¨");return res.json()}).then(data=>{localStorage.setItem("accessToken",data.accessToken);localStorage.setItem("refreshToken",data.refreshToken);token=data.accessToken;alert("ë¡œê·¸ì¸ ì„±ê³µ")}).catch(err=>alert(err.message))}
    function reissueToken(){const accessToken=localStorage.getItem("accessToken");const refreshToken=localStorage.getItem("refreshToken");if(!accessToken||!refreshToken){return alert("í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.")}fetch("http://localhost:8080/api/auth/reissue",{method:"POST",headers:{"Content-Type":"application/json","Authorization":"Bearer "+accessToken},body:JSON.stringify({accessToken:accessToken,refreshToken:refreshToken})}).then(res=>{if(!res.ok)throw new Error("í† í° ì¬ë°œê¸‰ ì‹¤íŒ¨");return res.json()}).then(data=>{localStorage.setItem("accessToken",data.accessToken);token=data.accessToken;if(data.refreshToken){localStorage.setItem("refreshToken",data.refreshToken)}alert("í† í°ì´ ì¬ë°œê¸‰ ë˜ì—ˆìŠµë‹ˆë‹¤.")}).catch(err=>alert(err.message))}
    function logout(){const accessToken=localStorage.getItem("accessToken");const refreshToken=localStorage.getItem("refreshToken");if(!accessToken){return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.")}fetch("http://localhost:8080/api/auth/logout",{method:"POST",headers:{"Content-Type":"application/json","Authorization":"Bearer "+accessToken},body:JSON.stringify({accessToken:accessToken,refreshToken:refreshToken})}).then(res=>{if(!res.ok)throw new Error("ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨");localStorage.removeItem("accessToken");localStorage.removeItem("refreshToken");alert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.")}).catch(err=>alert(err.message))}
    function authTest(){const token=localStorage.getItem("accessToken");if(!token){alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");return}fetch("http://localhost:8080/api/auth/test",{method:"GET",headers:{"Authorization":"Bearer "+token}}).then(res=>{if(!res.ok)throw new Error("ì¸ì¦ ì‹¤íŒ¨");return res.text()}).then(data=>{document.getElementById("authResult").innerText=data}).catch(err=>alert(err.message))}
    function upload(){if(!token)return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");const files=document.getElementById("imageFile").files;const tip=document.getElementById("tip").value;const formData=new FormData();for(const file of files){formData.append("files",file)}formData.append("tip",tip);fetch("http://localhost:8080/guide/api/upload",{method:"POST",headers:{"Authorization":"Bearer "+token},body:formData}).then(res=>{if(!res.ok)throw new Error("ì—…ë¡œë“œ ì‹¤íŒ¨");return res.json()}).then(data=>{alert("ì—…ë¡œë“œ ì„±ê³µ")}).catch(err=>alert(err.message))}
    function toggleLike(guideId,likeBtn,likeCountSpan){if(!token)return alert("ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥´ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");fetch(`http://localhost:8080/guide/api/like/${guideId}`,{method:'POST',headers:{"Authorization":"Bearer "+token}}).then(res=>{if(!res.ok)throw new Error("ì¢‹ì•„ìš” ì²˜ë¦¬ ì‹¤íŒ¨");return res.json()}).then(data=>{likeBtn.textContent=data.liked?'â¤ï¸':'â™¡';likeCountSpan.textContent=data.likeCount}).catch(err=>alert(err.message))}
    function createGuideCard(g){const card=document.createElement("div");card.className="guide-card";const imgBox=document.createElement("div");imgBox.className="img-box";if(g.media&&g.media.length>0){g.media.slice(0,10).forEach((m,i)=>{const img=document.createElement("img");img.src="http://localhost:8080"+m.url;if(i!==0){img.style.display="none"}imgBox.appendChild(img)});imgBox.onclick=()=>{const imgs=imgBox.querySelectorAll("img");let idx=[...imgs].findIndex(el=>el.style.display!=="none");imgs[idx].style.display="none";imgs[(idx+1)%imgs.length].style.display="block"}}const tip=document.createElement("p");tip.textContent=g.tip;const metaInfo=document.createElement("div");metaInfo.className="meta-info";const viewSpan=document.createElement("span");viewSpan.className="view-count";viewSpan.textContent=`ì¡°íšŒìˆ˜: ${g.viewCount||0}`;const likeContainer=document.createElement("span");const likeBtn=document.createElement("button");likeBtn.className="like-btn";likeBtn.textContent=g.userHasLiked?'â¤ï¸':'â™¡';const likeCountSpan=document.createElement("span");likeCountSpan.className="like-count";likeCountSpan.textContent=g.likeCount;likeBtn.onclick=()=>toggleLike(g.id,likeBtn,likeCountSpan);likeContainer.append(likeBtn,likeCountSpan);metaInfo.append(viewSpan,likeContainer);const updateBtn=document.createElement("button");updateBtn.textContent="âœï¸ ìˆ˜ì •";updateBtn.onclick=()=>{const newTip=prompt("ìƒˆ íŒ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”:",g.tip);if(newTip)updateGuide(g.id,newTip)};const deleteBtn=document.createElement("button");deleteBtn.textContent="ğŸ—‘ï¸ ì‚­ì œ";deleteBtn.onclick=()=>{if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"))deleteGuide(g.id)};const btnGroup=document.createElement("div");btnGroup.className="button-group";btnGroup.append(updateBtn,deleteBtn);card.append(imgBox,tip,metaInfo,btnGroup);return card}
    function loadUserGuides(){if(!token)return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");fetch("http://localhost:8080/guide/api/my",{headers:{"Authorization":"Bearer "+token}}).then(r=>r.json()).then(list=>{const wrap=document.getElementById("guideWrap");wrap.innerHTML="";list.forEach(g=>{const card=createGuideCard(g);wrap.appendChild(card)})})}
    function fetchGuides(lat,lng,radius){if(!token)return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");document.getElementById("guideNear").innerHTML='<p>ê°€ì´ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';fetch(`http://localhost:8080/guide/api/nearby?lat=${lat}&lng=${lng}&radius=${radius}`,{headers:{"Authorization":"Bearer "+token}}).then(res=>{if(!res.ok){console.error("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜:",res.status);throw new Error('ê°€ì´ë“œ ë¡œë”© ì‹¤íŒ¨: ì„œë²„ ì˜¤ë¥˜.')}return res.json()}).then(list=>{console.log("ğŸ“¦ ë°›ì•„ì˜¨ ê°€ì´ë“œ ë¦¬ìŠ¤íŠ¸:",list);const wrap=document.getElementById("guideNear");wrap.innerHTML="";if(list.length===0){wrap.innerHTML='<p>ì£¼ë³€ì— ê°€ì´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';return}list.forEach(g=>{const card=createGuideCard(g);wrap.appendChild(card)})}).catch(err=>{console.error("ê°€ì´ë“œ ë¡œë”© ì‹¤íŒ¨:",err);document.getElementById("guideNear").innerHTML='<p>ê°€ì´ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';alert("ê°€ì´ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")})}
    function loadPhotos(){if(!token)return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");fetch("http://localhost:8080/media/list",{method:"GET",headers:{"Authorization":"Bearer "+token}}).then(res=>{if(!res.ok)throw new Error("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");return res.json()}).then(data=>{const container=document.getElementById("photoList");container.innerHTML="";data.forEach(media=>{console.log("media ê°ì²´:",media);const img=document.createElement("img");img.src="http://localhost:8080"+media.url;console.log("ìš”ì²­ URL : ",img.src);img.style.width="200px";img.style.margin="10px";container.appendChild(img)})}).catch(err=>alert(err.message))}
    function fetchPhotoCount(){fetch("http://localhost:8080/media/allphoto/count",{headers:{"Authorization":"Bearer "+token}}).then(res=>res.json()).then(count=>{totalCount=count;countText.innerText=`ğŸ“· ì „ì²´ ì‚¬ì§„ ìˆ˜: ${totalCount}ê°œ`}).catch(err=>{console.warn("ì´ ê°œìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨",err)})}
    function allPhotos(){if(loading)return;loading=true;loadingText.style.display="inline";fetch(`http://localhost:8080/media/allphoto?page=${page}&size=${size}`,{headers:{"Authorization":"Bearer "+token}}).then(res=>{if(!res.ok)throw new Error("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");return res.json()}).then(data=>{if(page===0){prevBtn.disabled=true}else{prevBtn.disabled=false}if((page+1)*size>=totalCount){done=true;nextBtn.disabled=true;nextBtn.innerText="âœ… ë§ˆì§€ë§‰ í˜ì´ì§€"}else{done=false;nextBtn.disabled=false;nextBtn.innerText="â¡ï¸ ë‹¤ìŒ"}photoContainer.innerHTML="";data.forEach(media=>{const fileName=media.fileName.toLowerCase();const fileUrl="http://localhost:8080"+media.url;if(fileName.endsWith(".heic")){const link=document.createElement("a");link.href=fileUrl;link.innerText=`${media.fileName} (HEIC íŒŒì¼ - ë‹¤ìš´ë¡œë“œ)`;link.download=media.fileName;link.style.display="block";link.style.margin="10px";photoContainer.appendChild(link)}else{const img=document.createElement("img");img.src=fileUrl;img.loading="lazy";img.style.width="200px";img.style.margin="10px";photoContainer.appendChild(img)}});loading=false;loadingText.style.display="none"}).catch(err=>{alert(err.message);loading=false;loadingText.style.display="none"})}
    function updateGuide(id,newTip){fetch(`http://localhost:8080/guide/api/update`,{method:"PUT",headers:{"Content-Type":"application/json","Authorization":"Bearer "+token},body:JSON.stringify({id:id,tip:newTip})}).then(()=>{alert("ìˆ˜ì • ì™„ë£Œ");loadUserGuides()}).catch(err=>{alert("ìˆ˜ì • ì‹¤íŒ¨");console.error(err)})}
    function deleteGuide(id){fetch(`http://localhost:8080/guide/api/delete/${id}`,{method:"DELETE",headers:{"Authorization":"Bearer "+token}}).then(()=>{alert("ì‚­ì œ ì™„ë£Œ");loadUserGuides()}).catch(err=>{alert("ì‚­ì œ ì‹¤íŒ¨");console.error(err)})}
    function loadMembers(){if(!token){alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");return}fetch("http://localhost:8080/api/members",{headers:{"Authorization":"Bearer "+token}}).then(res=>{if(!res.ok)throw new Error("ë©¤ë²„ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");return res.json()}).then(data=>{const list=document.getElementById("memberList");list.innerHTML="";data.forEach(member=>{const li=document.createElement("li");li.textContent=`${member.id}: ${member.email}`;list.appendChild(li)})}).catch(err=>alert(err.message))}
</script>
</body>
</html>

